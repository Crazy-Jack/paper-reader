<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
  <title>Thesis Editor</title>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <h1>Paper Reader</h1>
      <div class="header-tabs">
        <button id="tab-thesis" class="tab-btn active">Thesis Editor</button>
        <button id="tab-agent" class="tab-btn">Research Agent</button>
      </div>
      <div class="header-actions">
        <button id="save-btn" class="btn btn-primary">Save</button>
        <button id="export-btn" class="btn btn-secondary">Export TXT</button>
        <button id="export-html-btn" class="btn btn-secondary">Export HTML</button>
      </div>
    </header>
    <main class="app-main">
      <div class="workspace">
        <!-- Thesis Editor Section -->
        <section class="thesis-section">
          <div class="section-header">
            <h2>Thesis</h2>
            <div class="editor-toolbar">
              <button id="insert-image-btn" class="btn btn-small" title="Insert Image">Insert Image</button>
            </div>
          </div>
          <div class="thesis-editor-container">
            <div 
              id="thesis-editor" 
              class="thesis-editor" 
              contenteditable="true"
              data-placeholder="Start writing your thesis here...

Use the 'Insert Citation' button or type [@ref1] to add references.
Use 'Insert Image' to add images from your computer."
            ></div>
          </div>
        </section>

        <!-- References Section -->
        <section class="references-section">
          <div class="section-header">
            <h2>References</h2>
            <button id="add-ref-btn" class="btn btn-primary btn-small">+ Add Reference</button>
          </div>
          <div id="references-list" class="references-list">
            <!-- References will be dynamically added here -->
          </div>
        </section>
      </div>
      
      <!-- Research Agent Section -->
      <div id="agent-section" class="agent-section" style="display: none;">
        <div class="agent-container">
          <div class="agent-sidebar">
            <div class="settings-section">
              <div class="settings-header">
                <h4>Settings</h4>
                <button id="toggle-settings-btn" class="btn-toggle" title="Collapse/Expand">‚ñº</button>
              </div>
              <div id="settings-content" class="settings-content">
                <div class="setting-group">
                  <label for="gemini-api-key">Gemini API Key:</label>
                  <input type="password" id="gemini-api-key" class="setting-input" placeholder="Enter your Gemini API key...">
                  <button id="save-api-key-btn" class="btn btn-primary btn-small" style="width: 100%; margin-top: 0.5rem;">Save API Key</button>
                  <small class="setting-help">Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                  <small class="setting-help" style="color: #27ae60; margin-top: 0.25rem; display: none;" id="api-key-saved-indicator">‚úì API key is saved and will be loaded automatically</small>
                </div>
              </div>
            </div>
            
            <div class="paper-selector">
              <div class="paper-selector-header">
                <h3>Paper Database</h3>
                <button id="toggle-paper-db-btn" class="btn-toggle" title="Collapse/Expand">‚ñº</button>
              </div>
              <div id="paper-db-content" class="paper-db-content">
                <select id="paper-dataset-select" class="paper-select">
                  <option value="">Select dataset...</option>
                  <option value="ICLR_2025">ICLR 2025</option>
                  <option value="NeurIPS_2025">NeurIPS 2025</option>
                </select>
                <button id="load-papers-btn" class="btn btn-primary btn-small">Load Papers</button>
                <div id="paper-count" class="paper-count"></div>
              </div>
            </div>
            
            <div class="paper-filters">
              <div class="paper-filters-header">
                <h4>Filters</h4>
                <button id="toggle-filters-btn" class="btn-toggle" title="Collapse/Expand">‚ñº</button>
              </div>
              <div id="filters-content" class="filters-content">
                <div class="filter-group">
                  <label>Presentation Type:</label>
                  <select id="filter-presentation" class="filter-select">
                    <option value="">All</option>
                    <option value="Oral">Oral</option>
                    <option value="Spotlight">Spotlight</option>
                    <option value="Poster">Poster</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label>Search Papers:</label>
                  <input type="text" id="search-papers" class="filter-input" placeholder="Search by title, abstract...">
                </div>
                <div class="filter-group">
                  <button id="find-relevant-papers-btn" class="btn btn-primary btn-small" style="width: 100%; margin-top: 0.5rem;">Find Papers Relevant to Thesis</button>
                  <small class="setting-help">Searches papers based on your thesis content</small>
                </div>
              </div>
            </div>
            
            <div class="loaded-contexts-info" id="loaded-contexts-info" style="display: none;">
              <div class="loaded-contexts-header">
                <h4>Loaded Contexts</h4>
                <button id="toggle-contexts-btn" class="btn-toggle" title="Collapse/Expand">‚ñº</button>
              </div>
              <div id="loaded-contexts-content" class="loaded-contexts-content">
                <div id="loaded-contexts-list" class="loaded-contexts-list"></div>
                <button id="clear-all-contexts-btn" class="btn btn-small btn-danger" style="width: 100%; margin-top: 0.5rem;">Clear All</button>
              </div>
            </div>
            
            <div id="paper-list" class="paper-list">
              <div class="empty-state">Load papers to get started</div>
            </div>
          </div>
          
          <div class="agent-main">
            <div class="chat-container">
              <div id="chat-messages" class="chat-messages">
                <div class="welcome-message">
                  <h2>Research Agent</h2>
                  <p>Ask questions about recent papers to generate research ideas!</p>
                  <p>Example questions:</p>
                  <ul>
                    <li>"What are the main trends in ICLR 2025?"</li>
                    <li>"Find papers related to transformer architectures"</li>
                    <li>"What are some unexplored research directions?"</li>
                    <li>"Compare different approaches to few-shot learning"</li>
                  </ul>
                </div>
              </div>
              <div class="chat-input-container">
                <div class="mode-toggle">
                  <button id="mode-toggle-btn" class="btn btn-toggle active" data-mode="ask">
                    <span class="mode-label">Ask Mode</span>
                  </button>
                </div>
                <textarea id="chat-input" class="chat-input" placeholder="Ask a question about the papers..." rows="3"></textarea>
                <div class="chat-actions">
                  <button id="send-btn" class="btn btn-primary">Send</button>
                  <button id="clear-btn" class="btn btn-secondary">Clear</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Reference Modal -->
  <div id="ref-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Add Reference</h3>
        <button class="modal-close" id="close-modal">&times;</button>
      </div>
      <div class="input-mode-toggle">
        <button type="button" id="toggle-form-mode" class="btn btn-small btn-secondary active">Form</button>
        <button type="button" id="toggle-bibtex-mode" class="btn btn-small btn-secondary">BibTeX</button>
      </div>
      
      <!-- Form Mode -->
      <form id="ref-form" class="ref-form">
        <div id="form-fields">
          <div class="form-group">
            <label for="ref-title">Title *</label>
            <input type="text" id="ref-title" required>
          </div>
          <div class="form-group">
            <label for="ref-authors">Authors *</label>
            <input type="text" id="ref-authors" placeholder="e.g., Smith, J., & Doe, A." required>
          </div>
          <div class="form-group">
            <label for="ref-year">Year</label>
            <input type="number" id="ref-year" placeholder="e.g., 2024">
          </div>
          <div class="form-group">
            <label for="ref-venue">Venue/Journal</label>
            <input type="text" id="ref-venue" placeholder="e.g., NeurIPS 2024">
          </div>
          <div class="form-group">
            <label for="ref-url">URL</label>
            <input type="url" id="ref-url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label for="ref-notes">Notes</label>
            <textarea id="ref-notes" rows="3" placeholder="Additional notes..."></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" id="cancel-ref-btn" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Reference</button>
        </div>
      </form>

      <!-- BibTeX Mode -->
      <div id="bibtex-input" class="bibtex-input" style="display: none;">
        <div class="form-group">
          <label for="bibtex-text">Paste BibTeX Entry</label>
          <textarea 
            id="bibtex-text" 
            rows="12" 
            placeholder="@article{key,&#10;  title={Paper Title},&#10;  author={Smith, John and Doe, Jane},&#10;  year={2024},&#10;  journal={Journal Name},&#10;  url={https://example.com}&#10;}"
            style="font-family: 'Courier New', monospace; font-size: 0.9rem;"
          ></textarea>
          <div class="bibtex-help">
            <small>Paste a BibTeX entry and click "Parse BibTeX" to auto-fill the form.</small>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" id="cancel-ref-btn-bibtex" class="btn btn-secondary">Cancel</button>
          <button type="button" id="parse-bibtex-btn" class="btn btn-primary">Parse BibTeX</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Proposal Modal -->
  <div id="edit-proposal-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Proposal</h3>
        <button class="modal-close" id="close-edit-proposal-modal">&times;</button>
      </div>
      <div class="proposal-description"></div>
      <div class="proposal-location" style="display: none;">
        <strong>üìç Edit Location:</strong>
        <pre class="proposal-location-text"></pre>
      </div>
      <div class="proposal-before-after">
        <div class="before">
          <strong>Before:</strong>
          <pre class="before-text"></pre>
        </div>
        <div class="after">
          <strong>After:</strong>
          <pre class="after-text"></pre>
        </div>
      </div>
      <div class="proposal-reasoning"></div>
      <div id="proposal-review" class="proposal-review" style="display: none;">
        <div class="review-verdict">
          <strong>Review Verdict:</strong>
          <span id="review-verdict-badge" class="review-badge"></span>
        </div>
        <div id="review-issues" class="review-issues" style="display: none;">
          <strong>Issues Found:</strong>
          <ul id="review-issues-list"></ul>
        </div>
        <div id="review-suggestions" class="review-suggestions" style="display: none;">
          <strong>Suggestions:</strong>
          <ul id="review-suggestions-list"></ul>
        </div>
      </div>
      <div class="modal-actions">
        <button id="approve-edit-btn" class="btn btn-primary">Approve</button>
        <button id="reject-edit-btn" class="btn btn-secondary">Reject</button>
      </div>
    </div>
  </div>

  <script src="renderer.js"></script>
  <script src="agent.js"></script>
</body>
</html>

