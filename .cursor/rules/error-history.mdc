---

### Feature: Gemini Google Search Grounding (2026)
**Encounter**: User requested adding a search function based on Gemini Google Search grounding.

**Solution**:
- Added IPC handler to call Gemini with `google_search` tool via REST.
- Exposed a new preload API for Google Search.
- Added web search handling in the agent with inline citations and sources.
- Documented web search usage in the UI.

**Files Changed**: `local-desktop-agent/main.js`, `local-desktop-agent/preload.js`, `local-desktop-agent/agent.js`, `local-desktop-agent/index.html`

---

### UI: Grounded Sources Display (2026)
**Encounter**: User reported that link rendering looked bad and URLs were too visible.

**Solution**:
- Render inline citations as clickable `[N]` links without URLs and remove the sources list.

**Files Changed**: `local-desktop-agent/agent.js`

---

### UI: Web Search HTML Rendering (2026)
**Encounter**: User saw raw `<a href="...">` tags rendered as text in web search results.

**Solution**:
- Render grounded responses as HTML for web search results while escaping the base text.
- Insert clickable `[N]` anchors at grounding positions.

**Files Changed**: `local-desktop-agent/agent.js`

---

### UI: Web Search Bullet Rendering (2026)
**Encounter**: User reported bullet points like `* **Agentic RAG**` were not rendered as list items.

**Solution**:
- Added list parsing in web search HTML formatter for `-`/`*` lines.

**Files Changed**: `local-desktop-agent/agent.js`

---

### UI: Web Search Inline Markdown (2026)
**Encounter**: User reported bolded list text like `**Agentic Retrieval-Augmented Generation (RAG)**:` not rendering well.

**Solution**:
- Added inline markdown handling (bold, italic, inline code) in web search HTML formatter.

**Files Changed**: `local-desktop-agent/agent.js`

---

### UI: Code Blocks and LaTeX Styling (2026)
**Encounter**: User requested improved code block and LaTeX rendering.

**Solution**:
- Added HTML-safe math wrapping for `$$...$$`, `\(...\)`, and `\[...\]`.
- Improved code block and inline code styling in chat UI.
- Added math block and inline math styling in chat UI.

**Files Changed**: `local-desktop-agent/agent.js`, `local-desktop-agent/styles/main.css`

---

### UI: Web Search Code Fences (2026)
**Encounter**: User reported fenced code blocks still rendering as plain text.

**Solution**:
- Added fenced code block parsing to HTML formatter and render as `<pre><code>`.

**Files Changed**: `local-desktop-agent/agent.js`

---

### UI: Code Block Contrast (2026)
**Encounter**: User reported code blocks were too low-contrast to read.

**Solution**:
- Darkened code block background and brightened code text for contrast.

**Files Changed**: `local-desktop-agent/styles/main.css`

---

### UI: Code Block Two-Tone Background (2026)
**Encounter**: User reported a second, lighter background inside code blocks.

**Solution**:
- Scoped inline code styling to exclude code blocks using `:not(pre) > code`.
- Ensured `<pre><code>` only uses a single background from the `pre` element.

**Files Changed**: `local-desktop-agent/styles/main.css`

---

### UI: Markdown Headings and Blocks (2026)
**Encounter**: User reported `###` headings not rendering correctly and asked for a systematic check.

**Solution**:
- Added heading, ordered list, blockquote, and horizontal rule handling in message rendering.
- Unified line-based rendering for better block-level markdown support.

**Files Changed**: `local-desktop-agent/agent.js`

---
alwaysApply: true
---
Always check this before implementing anything. Append the user encounter and the solution summary to the file 

.cursor/rules/error-history.mdc

## Electron Desktop App - Image Insertion and Resizing Issues (2024)

### Error 1: IPC Handler Not Registered - "No handler registered for 'select-image'"
**Encounter**: When clicking "Insert Image" button, error occurred: "Error invoking remote method 'select-image': Error: No handler registered for 'select-image'"

**Root Cause**: The IPC handler `ipcMain.handle('select-image', ...)` was registered at the top level before `app.whenReady()`, but the handler was trying to access `mainWindow` which didn't exist yet.

**Solution**: Moved the IPC handler registration inside `app.whenReady().then()` after `createWindow()` is called. Also added fallback to get focused window using `BrowserWindow.getFocusedWindow()`.

**Files Changed**: `local-desktop-agent/main.js`

---

### Error 2: Image Caption Always Centered - Can't Create Line Breaks
**Encounter**: After editing picture captions, text was always centered and user couldn't use Delete key to start the next line properly.

**Root Cause**: CSS had `text-align: center` on the figure element, and the figcaption didn't support proper line break editing with `white-space: pre-wrap`.

**Solution**: 
- Changed `text-align` for figcaption to `center` (as user wanted centered by default)
- Added `white-space: pre-wrap` to preserve line breaks
- Added Enter key handler to insert `<br>` tags for line breaks
- Added focus/blur styling for better editing experience

**Files Changed**: `local-desktop-agent/renderer.js`, `local-desktop-agent/styles/main.css`

---

### Error 3: Images Not Clickable - Resize Functionality Not Working
**Encounter**: User couldn't click images to select them, and resize handles weren't visible or functional.

**Root Cause**: 
- Event propagation issues - editor's click handler was deselecting images before they could be selected
- Missing `pointer-events: auto` CSS property on image containers
- Click handlers were not properly attached to image elements

**Solution**:
- Fixed click event handler on editor to check if clicking on image-related elements before deselecting
- Added `pointer-events: auto` and `cursor: pointer` to image container CSS
- Improved event propagation handling with `stopPropagation()` and `preventDefault()`
- Added click handlers to both image and container elements

**Files Changed**: `local-desktop-agent/renderer.js`, `local-desktop-agent/styles/main.css`

---

### Error 4: Variable Initialization Order - "Cannot access 'imageContainer' before initialization"
**Encounter**: Error when inserting images: "Error inserting image: Cannot access 'imageContainer' before initialization"

**Root Cause**: Variables `imageContainer` and `resizeHandle` were being referenced in event listeners before they were declared/initialized in the `insertImageAtCursor()` function.

**Solution**: Reordered variable declarations:
1. Create `resizeHandle` first
2. Create `imageContainer` second
3. Create `img` element
4. Append elements to container
5. Add event listeners after all elements exist

**Files Changed**: `local-desktop-agent/renderer.js`

---

### Key Learnings:
- **IPC Handlers in Electron**: Must be registered after `app.whenReady()` and window creation if they need to reference the window
- **Event Propagation**: Careful handling needed when multiple click handlers exist on parent/child elements
- **Variable Initialization**: Always declare variables before using them in event listeners or closures
- **Content Editable Elements**: Need proper CSS (`white-space: pre-wrap`) and keyboard event handlers to support multi-line editing

---

### Error 5: Images Overlaying Instead of Side-by-Side Layout
**Encounter**: When inserting images side-by-side, they were overlaying on top of each other instead of appearing horizontally next to each other.

**Root Cause**: 
- Missing `box-sizing: border-box` on containers causing width calculation issues
- Flex layout not properly constraining image widths
- Missing proper width constraints on figures in side-by-side containers

**Solution**:
- Added `box-sizing: border-box` to all image containers and side-by-side wrappers
- Set proper `max-width: calc(50% - 0.5rem)` on figures in side-by-side containers to account for gap
- Ensured images respect container width with `max-width: 100%`
- Made side-by-side container use proper flex layout with `display: flex` and `flex-direction: row`

**Files Changed**: `local-desktop-agent/styles/main.css`

---

### Error 6: Cannot Delete or Deselect Images
**Encounter**: User couldn't delete selected images and couldn't deselect images by clicking on text.

**Root Cause**: 
- No keyboard event handler for Delete/Backspace keys to delete images
- Click handler was too restrictive - only deselected on very specific conditions (BR tags or editor itself)
- Click handler didn't properly distinguish between clicking on text vs image elements

**Solution**:
- Added `keydown` event listener to handle Delete/Backspace keys for deleting selected images
- Improved click handler to properly detect clicks on text vs image elements
- Added logic to deselect when clicking on text content or empty space
- Added Escape key handler to deselect all images
- Created `deleteImage()` function that properly handles both regular figures and side-by-side containers
- Added cleanup logic to remove empty side-by-side containers and restore single images when only one remains

**Files Changed**: `local-desktop-agent/renderer.js`

---

### Error 7: Side-by-Side Button Name Unclear
**Encounter**: Button labeled "Side by Side" was not descriptive enough for users to understand its function.

**Root Cause**: Button name was too generic and didn't indicate it was for inserting images.

**Solution**: Renamed button from "Side by Side" to "Insert Side-by-Side" to be consistent with "Insert Image" button and make the action clear.

**Files Changed**: `local-desktop-agent/index.html`

---

### Error 8: Python Process Spawning Overhead - Loading Papers Too Slow
**Encounter**: User found the approach of spawning Python processes from Electron to load pickle files too slow and cumbersome. Each paper load required spawning a new Python process, parsing output, etc.

**Root Cause**: 
- Loading papers required spawning a Python child process for each request
- IPC communication overhead between Electron and Python
- Pickle files not directly readable by JavaScript

**Solution**:
- Created `convert_papers_to_json.py` script to convert pickle files to JSON once
- Store JSON files in `local-desktop-agent/data/` directory
- Updated `main.js` to read JSON files directly using Node.js `fs` module (no Python process needed)
- Removed Python process spawning code and `load_papers.py` script
- JSON files are loaded natively in JavaScript, much faster and simpler

**Files Changed**: 
- Created: `local-desktop-agent/convert_papers_to_json.py` (one-time conversion script)
- Created: `local-desktop-agent/data/` directory for JSON files
- Modified: `local-desktop-agent/main.js` (uses fs.readFileSync instead of spawn)
- Modified: `local-desktop-agent/agent.js` (updated error handling for new response format)
- Deleted: `local-desktop-agent/load_papers.py` (no longer needed)

**Usage**: Run `python3 local-desktop-agent/convert_papers_to_json.py` from the project root once to convert all pickle files to JSON. The app then loads JSON files directly without Python.

---
